version: "3.9"

services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    environment:
      - SERVICES=ses,sesv2,dynamodb,sns,sqs,sts
      - AWS_DEFAULT_REGION=ap-southeast-1
      - DEBUG=1
      - TABLE_PREFIX=
      - SERVICE_NAME=accounts_service
      - INITIAL_VERSION=0.0.0
    ports:
      - "4566:4566"
    volumes:
      - localstack-data:/var/lib/localstack
      - ./localstack-init:/etc/localstack/init/ready.d
    healthcheck:
      test: ["CMD", "bash", "-lc", "awslocal --version >/dev/null 2>&1 || pip install awscli-local -q; awslocal sts get-caller-identity >/dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      devnet:
        aliases:
          - localstack

  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      DYNAMO_ENDPOINT: http://localstack:4566
      AWS_REGION: ap-southeast-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - devnet

  account-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: ph-shoes-account-service
    ports:
      - "8082:8082"
    env_file:
      - ../.env
    environment:
      GH_ACTOR: ${GH_ACTOR}
      GH_PACKAGES_TOKEN: ${GH_PACKAGES_TOKEN}
      NOTIFICATION_PROVIDER: smtp
      NOTIFICATION_TRANSPORT: smtp
      NOTIFICATION_SMTP_HOST: mailhog
      NOTIFICATION_SMTP_PORT: 1025
      SES_WEBHOOK_VERIFY_SIGNATURE: false
      SES_WEBHOOK_AUTO_CONFIRM: false
      SES_WEBHOOK_ALLOWED_TOPICS: "*"
      SPRINGDOC_API_DOCS_ENABLED: true
      SPRINGDOC_SWAGGER_UI_ENABLED: true
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_REGION: ap-southeast-1
      AWS_ENDPOINT: http://localstack:4566
      SPRING_DEVTOOLS_RESTART_ADDITIONAL_PATHS: src/main/java,src/main/resources
    volumes:
      - ./:/app
      - "${HOME}/.m2:/root/.m2"
    command: >
      bash -lc "set -euo pipefail;
        mvn -s .mvn/settings.xml -pl ph-shoes-user-accounts-service-core -am -U -Pdev clean install -q &&
        cd ph-shoes-user-accounts-service-web &&
        mvn -s ../.mvn/settings.xml -am -U -Pdev spring-boot:run \
          -Dspring-boot.run.fork=false \
          -Dspring-boot.run.jvmArguments=\"${JAVA_TOOL_OPTIONS}\" \
          -Dopenapi.docs.url=http://localhost:8082/v3/api-docs.yaml"
    depends_on:
      localstack:
        condition: service_healthy
      mailhog:
        condition: service_started
    networks:
      - devnet

  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # http://localhost:8025
    networks:
      - devnet
    depends_on:
      localstack:
        condition: service_healthy

networks:
  devnet: {}

volumes:
  localstack-data: {}
